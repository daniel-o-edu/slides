<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoSlide GenAI (Python)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'] },
            aspectRatio: { '4/3': '4 / 3' },
          },
        },
      }
    </script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- PDF & Office Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- PDF.js for reading PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <!-- PptxGenJS for Google Slides/PowerPoint export -->
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <!-- PyScript -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

    <!-- Import Map for GenAI -->
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .slide-content ul { list-style-type: disc; padding-left: 1.5rem; }
        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 h-screen w-full flex overflow-hidden">

    <!-- JS Bridge -->
    <script type="module">
        import { GoogleGenAI, Type } from "@google/genai";

        // Expose API Key (Injected by environment)
        window.API_KEY = process.env.API_KEY;

        // --- 1. PDF Extraction Service ---
        window.extractPdfTextJS = async (fileInputId) => {
            const input = document.getElementById(fileInputId);
            if (!input.files || !input.files[0]) return null;

            const file = input.files[0];
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            
            let fullText = "";
            // Limit to first 10 pages to avoid token limits
            const maxPages = Math.min(pdf.numPages, 10);
            
            for (let i = 1; i <= maxPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + "\n";
            }
            return fullText;
        };

        // --- 2. Gemini Service ---
        window.generateSlidesJS = async (apiKey, topic, includeImages) => {
            if (!apiKey) throw new Error("API Key not found");
            const ai = new GoogleGenAI({ apiKey: apiKey });
            
            let prompt = `Create a presentation based on the following text/topic: "${topic}". 
            Break it down into logical slides. 
            The first slide should be a Title slide. 
            The last slide should be a Summary slide.
            Keep bullet points concise. Return JSON.`;

            if (includeImages) {
                prompt += ` For each slide, also provide a short, descriptive English prompt for an AI image generator in the 'imageDescription' field.`;
            }

            const response = await ai.models.generateContent({
                model: "gemini-2.5-flash",
                contents: prompt,
                config: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: Type.OBJECT,
                        properties: {
                            topic: { type: Type.STRING },
                            slides: {
                                type: Type.ARRAY,
                                items: {
                                    type: Type.OBJECT,
                                    properties: {
                                        title: { type: Type.STRING },
                                        content: { type: Type.ARRAY, items: { type: Type.STRING } },
                                        type: { type: Type.STRING, enum: ["title", "content", "summary"] },
                                        imageDescription: { type: Type.STRING, description: "Visual description for background or side image" }
                                    },
                                    required: ["title", "content", "type"]
                                }
                            }
                        },
                        required: ["topic", "slides"]
                    }
                }
            });
            return response.text;
        };

        // --- 3. Export Services ---
        
        // PDF Export
        window.generatePDFJS = async (filename) => {
            const { jsPDF } = window.jspdf;
            const container = document.getElementById('pdf-hidden-container');
            const slides = container.querySelectorAll('.slide-node');
            
            if (slides.length === 0) return;

            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'px',
                format: [800, 600]
            });

            for (let i = 0; i < slides.length; i++) {
                const slide = slides[i];
                // Wait for images to load if any
                const imgs = slide.querySelectorAll('img');
                await Promise.all(Array.from(imgs).map(img => {
                    if (img.complete) return Promise.resolve();
                    return new Promise(resolve => { img.onload = resolve; img.onerror = resolve; });
                }));

                const canvas = await window.html2canvas(slide, { scale: 2, useCORS: true, logging: false });
                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                
                if (i > 0) doc.addPage([800, 600], 'landscape');
                doc.addImage(imgData, 'JPEG', 0, 0, 800, 600);
            }
            doc.save(`${filename}.pdf`);
        };

        // HTML Export
        window.downloadHTMLJS = (filename, content) => {
            const element = document.createElement('a');
            const file = new Blob([content], {type: 'text/html'});
            element.href = URL.createObjectURL(file);
            element.download = filename;
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        };

        // PPTX Export (Google Slides Compatible)
        window.generatePPTXJS = (topic, slidesData, themeData) => {
            const pres = new PptxGenJS();
            pres.layout = 'LAYOUT_4x3';
            pres.title = topic;
            pres.author = 'AutoSlide AI';

            // Helper to get image URL if exists
            const getImageUrl = (desc) => {
                if (!desc) return null;
                return `https://image.pollinations.ai/prompt/${encodeURIComponent(desc)}?width=800&height=600&nologo=true`;
            };

            const bgHex = themeData.bg.replace('#', '');
            const textHex = themeData.text.replace('#', '');
            const accentHex = themeData.accent.replace('#', '');

            slidesData.forEach((slide) => {
                let pptSlide = pres.addSlide();
                pptSlide.background = { color: bgHex };
                
                // Title
                pptSlide.addText(slide.title, { 
                    x: 0.5, y: 0.5, w: '90%', h: 1, 
                    fontSize: 32, color: accentHex, bold: true, align: 'center' 
                });

                // Image
                if (slide.imageDescription) {
                   const imgUrl = getImageUrl(slide.imageDescription);
                   // Place image on the right or background depending on layout
                   if (slide.type === 'title' || slide.type === 'summary') {
                       // Background image style (simulated with large image)
                        pptSlide.addImage({ path: imgUrl, x: 0, y: 0, w: '100%', h: '100%', transparency: 85 });
                   } else {
                        pptSlide.addImage({ path: imgUrl, x: 5.5, y: 1.8, w: 4, h: 3 });
                   }
                }

                // Content
                if (slide.content && slide.content.length > 0) {
                    let textConfig = { 
                        x: 0.5, y: 1.8, w: slide.imageDescription ? '50%' : '90%', h: 4, 
                        fontSize: 18, color: textHex, bullet: true, align: 'left'
                    };
                    
                    if (slide.type === 'title' || slide.type === 'summary') {
                         textConfig.align = 'center';
                         textConfig.bullet = false;
                         textConfig.w = '90%';
                    }

                    // Join content for pptx text body
                    let contentText = slide.content.map(c => c).join('\n');
                    pptSlide.addText(contentText, textConfig);
                }
            });

            pres.writeFile({ fileName: `${topic.replace(/\s+/g, '_')}.pptx` });
        }
    </script>

    <!-- App Container -->
    <div id="app" class="flex w-full h-full">
        <!-- Sidebar -->
        <div class="w-96 bg-white border-r border-gray-200 flex flex-col shadow-xl z-10 flex-shrink-0">
            <div class="p-6 border-b border-gray-100">
                <h1 class="font-bold text-xl text-indigo-600 flex items-center gap-2">
                    <span>üêç</span> AutoSlide Py
                </h1>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                
                <!-- PDF Import -->
                <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                    <label class="block text-xs font-semibold text-indigo-800 mb-2 uppercase tracking-wide">Import Content</label>
                    <div class="flex items-center justify-center w-full">
                        <label for="pdf-upload" class="flex flex-col items-center justify-center w-full h-24 border-2 border-indigo-300 border-dashed rounded-lg cursor-pointer hover:bg-indigo-100 transition-colors">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <svg class="w-6 h-6 mb-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                <p class="mb-2 text-xs text-indigo-600"><span class="font-semibold">Click to upload PDF</span></p>
                            </div>
                            <input id="pdf-upload" type="file" class="hidden" accept=".pdf" />
                        </label>
                    </div>
                </div>

                <!-- Topic Input -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Topic / Content</label>
                    <textarea id="topic-input" class="w-full h-32 p-3 rounded-lg border border-gray-200 text-sm focus:ring-2 focus:ring-indigo-500 outline-none resize-none" placeholder="Enter topic manually or import PDF..."></textarea>
                    
                    <!-- Options -->
                    <div class="mt-3 flex items-center gap-2">
                        <input type="checkbox" id="chk-images" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="chk-images" class="text-sm text-gray-700">Auto-generate Images</label>
                    </div>

                    <button id="generate-btn" py-click="controller.handle_generate" class="mt-4 w-full py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-colors flex justify-center items-center gap-2">
                        <span>Generate Slides</span>
                    </button>
                </div>

                <!-- Theme Selector -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Theme</label>
                    <div id="theme-container" class="grid grid-cols-2 gap-2">
                        <!-- Populated by Python -->
                    </div>
                </div>

                <!-- Export -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Export</label>
                    <div class="grid grid-cols-1 gap-2">
                        <button py-click="controller.handle_export_pptx" class="flex items-center justify-center gap-2 p-2 border border-orange-200 bg-orange-50 hover:bg-orange-100 text-orange-700 rounded text-sm font-medium">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2M9 15H7v-2h2zm0-4H7V9h2zm4 4h-2v-2h2zm0-4h-2V9h2zm4 4h-2v-2h2zm0-4h-2V9h2z"/></svg>
                            Google Slides (.pptx)
                        </button>
                        <div class="grid grid-cols-2 gap-2">
                            <button py-click="controller.handle_export_pdf" class="p-2 border rounded hover:bg-gray-50 text-sm font-medium text-gray-700">PDF</button>
                            <button py-click="controller.handle_export_html" class="p-2 border rounded hover:bg-gray-50 text-sm font-medium text-gray-700">HTML</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Preview -->
        <div class="flex-1 bg-slate-200 flex flex-col relative overflow-hidden">
            <!-- Toolbar -->
            <div class="h-16 bg-white border-b flex items-center justify-between px-6 shadow-sm z-10">
                <span id="header-topic" class="font-semibold text-gray-700 truncate">My Presentation</span>
                <div class="flex items-center gap-4">
                    <span id="slide-counter" class="text-sm text-gray-500 font-mono">1 / 1</span>
                    <div class="flex gap-1">
                        <button py-click="controller.prev_slide" class="p-2 hover:bg-gray-100 rounded text-gray-600">Previous</button>
                        <button py-click="controller.next_slide" class="p-2 hover:bg-gray-100 rounded text-gray-600">Next</button>
                    </div>
                </div>
            </div>

            <!-- Slide Stage -->
            <div class="flex-1 flex items-center justify-center p-8 overflow-hidden">
                <div id="slide-stage" class="w-full max-w-4xl shadow-2xl transition-all duration-300">
                    <!-- Slide Rendered Here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Container for PDF Rendering -->
    <div id="pdf-hidden-container" class="absolute top-0 left-0 pointer-events-none opacity-0 -z-50 w-[800px]"></div>

    <!-- Python Application Logic -->
    <script type="py">
import json
import asyncio
from js import document, window, console, JSON
from pyodide.ffi import create_proxy, to_js

# --- CONSTANTS ---
THEMES = [
    {"id": "modern-dark", "name": "Midnight", "bg": "#0f172a", "text": "#f8fafc", "accent": "#38bdf8", "is_dark": True},
    {"id": "clean-light", "name": "Clean Day", "bg": "#ffffff", "text": "#1e293b", "accent": "#2563eb", "is_dark": False},
    {"id": "forest", "name": "Forest", "bg": "#064e3b", "text": "#ecfdf5", "accent": "#34d399", "is_dark": True},
    {"id": "sunset", "name": "Sunset", "bg": "#450a0a", "text": "#fff1f2", "accent": "#fb7185", "is_dark": True},
]

INITIAL_SLIDES = [
    {"title": "Welcome to AutoSlide Py", "content": ["Import PDF or enter topic", "Toggle images if desired", "Click Generate"], "type": "title"}
]

# Initialize global controller variable to avoid NameError if accessed early
controller = None

# --- MODEL ---
class PresentationModel:
    def __init__(self):
        self.topic = "My Presentation"
        self.slides = INITIAL_SLIDES
        self.current_theme = THEMES[0]
        self.current_index = 0
        self.is_generating = False
        self.include_images = False
        self.observers = []

    def subscribe(self, observer):
        self.observers.append(observer)

    def notify(self):
        for observer in self.observers:
            observer.update(self)

    def set_slides(self, topic, slides):
        self.topic = topic
        self.slides = slides
        self.current_index = 0
        self.notify()

    def set_theme(self, theme_id):
        for theme in THEMES:
            if theme["id"] == theme_id:
                self.current_theme = theme
                self.notify()
                break

    def next_slide(self):
        if self.current_index < len(self.slides) - 1:
            self.current_index += 1
            self.notify()

    def prev_slide(self):
        if self.current_index > 0:
            self.current_index -= 1
            self.notify()

    def set_generating(self, is_gen):
        self.is_generating = is_gen
        self.notify()

# --- VIEW ---
class PresentationView:
    def __init__(self):
        self.slide_stage = document.getElementById("slide-stage")
        self.theme_container = document.getElementById("theme-container")
        self.slide_counter = document.getElementById("slide-counter")
        self.header_topic = document.getElementById("header-topic")
        self.topic_input = document.getElementById("topic-input")
        self.generate_btn = document.getElementById("generate-btn")
        self.pdf_container = document.getElementById("pdf-hidden-container")
        
        # PDF Input
        self.pdf_upload = document.getElementById("pdf-upload")

    def init_ui(self, model, controller_proxy):
        # Render themes
        self.theme_container.innerHTML = ""
        for theme in THEMES:
            btn = document.createElement("button")
            btn.className = f"p-2 border rounded flex items-center gap-2 hover:border-indigo-500 transition-colors"
            dot = f'<div class="w-4 h-4 rounded-full border" style="background-color: {theme["bg"]}"></div>'
            btn.innerHTML = f'{dot}<span class="text-xs font-semibold">{theme["name"]}</span>'
            
            # Use controller_proxy passed in args, instead of global variable
            def make_handler(tid, ctrl):
                return lambda e: ctrl.set_theme(tid)
            
            btn.onclick = make_handler(theme["id"], controller_proxy)
            self.theme_container.appendChild(btn)
            
        # Bind PDF Input listener using the proxy instance
        self.pdf_upload.addEventListener("change", create_proxy(controller_proxy.handle_pdf_upload))

        self.update(model)

    def get_image_url(self, description):
        # Using Pollinations.ai for simple, free generative images
        if not description: return ""
        encoded = window.encodeURIComponent(description)
        return f"https://image.pollinations.ai/prompt/{encoded}?width=800&height=600&nologo=true"

    def generate_html_string(self, slide, theme, index, total, width="100%", height="100%", is_preview=True):
        bg_color = theme["bg"]
        text_color = theme["text"]
        accent = theme["accent"]
        
        img_html = ""
        if "imageDescription" in slide and slide["imageDescription"]:
             url = self.get_image_url(slide["imageDescription"])
             img_html = f'<img src="{url}" class="absolute opacity-20 object-cover w-full h-full mix-blend-overlay" />'
             # For content slides, maybe a side image?
             if slide["type"] == "content":
                 img_html = f'<div class="w-1/2 h-full absolute right-0 top-0 opacity-40"><img src="{url}" class="w-full h-full object-cover mask-image-gradient" /></div>'
        
        content_html = ""
        
        if slide["type"] == "title":
            items = "".join([f'<p class="text-xl opacity-80 mb-2 relative z-10">{item}</p>' for item in slide["content"]])
            content_html = f'''
                {img_html}
                <div class="flex flex-col items-center justify-center h-full text-center p-12 relative z-10">
                    <h1 class="text-5xl font-bold mb-6" style="color: {accent}">{slide["title"]}</h1>
                    <div class="max-w-2xl">{items}</div>
                </div>
            '''
        elif slide["type"] == "summary":
            items = "".join([f'<p class="text-2xl font-light mb-4 relative z-10">{item}</p>' for item in slide["content"]])
            content_html = f'''
                {img_html}
                <div class="flex flex-col items-center justify-center h-full text-center p-12 relative">
                    <div class="absolute top-0 left-0 w-32 h-32 opacity-10 rounded-br-full z-0" style="background-color: {accent}"></div>
                    <h2 class="text-4xl font-bold mb-8 relative z-10" style="color: {accent}">{slide["title"]}</h2>
                    <div class="space-y-4 relative z-10">{items}</div>
                </div>
            '''
        else:
            # Layout adjustment for image
            list_width = "w-1/2" if img_html else "w-full"
            items = "".join([f'<li class="mb-3 pl-2 flex"><span class="mr-2" style="color: {accent}">‚Ä¢</span>{item}</li>' for item in slide["content"]])
            content_html = f'''
                {img_html}
                <div class="flex flex-col h-full p-12 relative z-10 {list_width}">
                    <div class="mb-8 border-b pb-4" style="border-color: {theme["text"]}33">
                        <h2 class="text-4xl font-bold" style="color: {accent}">{slide["title"]}</h2>
                    </div>
                    <ul class="text-2xl flex-grow">{items}</ul>
                </div>
            '''

        container_class = "w-full aspect-[4/3] shadow-2xl relative overflow-hidden select-none" if is_preview else "w-[800px] h-[600px] relative overflow-hidden slide-node mb-10"
        
        return f'''
            <div class="{container_class}" style="background-color: {bg_color}; color: {text_color}; font-family: 'Inter', sans-serif;">
                <div class="absolute top-0 right-0 w-2 h-full opacity-20" style="background-color: {accent}"></div>
                {content_html}
                <div class="absolute bottom-4 right-6 text-sm opacity-50 font-mono z-20">{index + 1} / {total}</div>
            </div>
        '''

    def update(self, model):
        current_slide = model.slides[model.current_index]
        html = self.generate_html_string(current_slide, model.current_theme, model.current_index, len(model.slides))
        self.slide_stage.innerHTML = html
        self.header_topic.innerText = model.topic
        self.slide_counter.innerText = f"{model.current_index + 1} / {len(model.slides)}"

        if model.is_generating:
            self.generate_btn.disabled = True
            self.generate_btn.innerHTML = '<div class="loading-spinner"></div> Working...'
            self.generate_btn.classList.add("opacity-75", "cursor-not-allowed")
        else:
            self.generate_btn.disabled = False
            self.generate_btn.innerHTML = '<span>Generate Slides</span>'
            self.generate_btn.classList.remove("opacity-75", "cursor-not-allowed")

    def prepare_pdf_dom(self, model):
        html_all = ""
        for i, slide in enumerate(model.slides):
            html_all += self.generate_html_string(slide, model.current_theme, i, len(model.slides), is_preview=False)
        self.pdf_container.innerHTML = html_all

# --- CONTROLLER ---
class PresentationController:
    def __init__(self, model, view):
        self.model = model
        self.view = view
        self.view.init_ui(model, self)

    def set_theme(self, theme_id):
        self.model.set_theme(theme_id)

    def next_slide(self, event=None):
        self.model.next_slide()

    def prev_slide(self, event=None):
        self.model.prev_slide()

    async def handle_pdf_upload(self, event):
        self.model.set_generating(True)
        try:
            # Call JS to parse PDF
            text = await window.extractPdfTextJS("pdf-upload")
            if text:
                self.view.topic_input.value = text.strip()
                # Optional: Trim text if too long for prompt context, though Flash handles 1M tokens
                if len(text) > 30000:
                    window.alert("PDF text is very long. Using the first ~30k characters.")
                    self.view.topic_input.value = text[:30000] + "..."
            else:
                window.alert("Could not extract text from PDF.")
        except Exception as e:
            console.error(str(e))
            window.alert("Error parsing PDF")
        finally:
            self.model.set_generating(False)

    async def handle_generate(self, event=None):
        topic_text = self.view.topic_input.value
        if not topic_text.strip():
            window.alert("Please enter a topic or upload a PDF.")
            return

        include_images = document.getElementById("chk-images").checked
        self.model.set_generating(True)
        
        try:
            api_key = window.API_KEY
            if not api_key:
                window.alert("API Key is missing.")
                self.model.set_generating(False)
                return

            json_response = await window.generateSlidesJS(api_key, topic_text, include_images)
            data = json.loads(json_response)
            
            self.model.set_slides(data["topic"], data["slides"])
            
        except Exception as e:
            console.error(f"Error: {str(e)}")
            window.alert("Failed to generate slides.")
        finally:
            self.model.set_generating(False)

    async def handle_export_pdf(self, event=None):
        self.model.set_generating(True)
        try:
            self.view.prepare_pdf_dom(self.model)
            await asyncio.sleep(0.5) # Wait for DOM
            await window.generatePDFJS(self.model.topic.replace(" ", "_"))
        except Exception as e:
            console.error(e)
            window.alert("Error generating PDF")
        finally:
            self.model.set_generating(False)
            self.view.pdf_container.innerHTML = ""

    def handle_export_pptx(self, event=None):
        # Prepare data for JS function
        # Convert Python objects to JS-compatible structure via JSON serialization
        slides_json = json.dumps(self.model.slides)
        theme_json = json.dumps(self.model.current_theme)
        
        # Parse on JS side or pass parsed objects
        # PyScript's JSON.parse can return a JS object
        js_slides = JSON.parse(slides_json)
        js_theme = JSON.parse(theme_json)
        
        window.generatePPTXJS(self.model.topic, js_slides, js_theme)

    def handle_export_html(self, event=None):
        topic_slug = self.model.topic.replace(" ", "_")
        slides_html = ""
        theme = self.model.current_theme
        for i, slide in enumerate(self.model.slides):
            img_tag = ""
            if "imageDescription" in slide and slide["imageDescription"]:
                url = self.view.get_image_url(slide["imageDescription"])
                img_tag = f'<img src="{url}" style="max-width:300px; float:right; margin: 10px; border-radius: 8px;">'

            slides_html += f"""
            <div class="slide" id="slide-{i}">
                {img_tag}
                <h1>{slide['title']}</h1>
                <ul>{''.join([f'<li>{p}</li>' for p in slide['content']])}</ul>
                <div class="footer">{i+1} / {len(self.model.slides)}</div>
            </div>
            """
            
        full_html = f"""
<!DOCTYPE html>
<html>
<head>
<title>{self.model.topic}</title>
<style>
    body {{ font-family: sans-serif; background: #222; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 20px; }}
    .slide {{ 
        width: 800px; height: 600px; 
        background: {theme['bg']}; color: {theme['text']}; 
        padding: 40px; box-sizing: border-box; position: relative; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.3); overflow: hidden;
    }}
    .slide h1 {{ color: {theme['accent']}; }}
    .slide ul {{ font-size: 1.2rem; line-height: 1.6; }}
    .footer {{ position: absolute; bottom: 20px; right: 20px; opacity: 0.5; }}
</style>
</head>
<body>
    {slides_html}
</body>
</html>
        """
        window.downloadHTMLJS(f"{topic_slug}.html", full_html)

# --- MAIN ---
async def main():
    model = PresentationModel()
    view = PresentationView()
    model.subscribe(view)
    global controller
    controller = PresentationController(model, view)

asyncio.ensure_future(main())
    </script>
</body>
</html>