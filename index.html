<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoSlide GenAI (Python)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'] },
            colors: {
                brand: {
                    black: '#1a1a1a',
                    gray: '#f4f4f5',
                    accent: '#2563eb'
                }
            }
          },
        },
      }
    </script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Lora:ital,wght@0,400;0,600;1,400&family=Montserrat:wght@400;600;800&family=Open+Sans:wght@400;600&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- PDF & Office Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <!-- PyScript -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

    <!-- Import Map for GenAI -->
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0"
  }
}
</script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fafafa; color: #1a1a1a; }
        
        /* Minimalist Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d4d4d8; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #a1a1aa; }

        /* Custom Color Input Styling */
        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            overflow: hidden;
            padding: 0;
            background: none;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 50%; }
        
        .loading-spinner {
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 2px solid #fff;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Edit Image Button Overlay */
        .slide-image-container:hover .edit-image-btn {
            opacity: 1;
        }
    </style>
</head>
<body class="h-screen w-full flex overflow-hidden">

    <!-- JS Bridge -->
    <script type="module">
        import { GoogleGenAI, Type } from "@google/genai";

        window.API_KEY = process.env.API_KEY;

        // --- 0. Helper: Convert URL/File to Base64 ---
        window.urlToBase64 = async (url) => {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.error("Error converting image to base64:", error);
                return null;
            }
        };

        window.readLocalFileToBase64 = (fileInputId) => {
            return new Promise((resolve, reject) => {
                const input = document.getElementById(fileInputId);
                if (!input.files || !input.files[0]) {
                    resolve(null);
                    return;
                }
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsDataURL(file);
            });
        };

        // --- 1. PDF Extraction ---
        window.extractPdfTextJS = async (fileInputId) => {
            const input = document.getElementById(fileInputId);
            if (!input.files || !input.files[0]) return null;
            const file = input.files[0];
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let fullText = "";
            const maxPages = Math.min(pdf.numPages, 8); // Limit pages for performance
            for (let i = 1; i <= maxPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + "\n";
            }
            return fullText;
        };

        // --- 2. Gemini Service (Portuguese Prompt) ---
        window.generateSlidesJS = async (apiKey, topic, includeImages) => {
            if (!apiKey) throw new Error("API Key not found");
            const ai = new GoogleGenAI({ apiKey: apiKey });
            
            // Explicitly requesting Portuguese content
            let prompt = `Atue como um especialista em apresentações. Crie uma apresentação de slides baseada no seguinte tópico ou texto: "${topic}".
            
            Requisitos:
            1. O idioma da resposta deve ser **Português do Brasil (pt-BR)**.
            2. Estruture em slides lógicos.
            3. O primeiro slide deve ser Título.
            4. O último slide deve ser Resumo/Conclusão.
            5. Slides de conteúdo devem ter bullet points concisos.
            6. Retorne estritamente JSON.`;

            if (includeImages) {
                prompt += ` Para cada slide, forneça também um 'imageDescription' (em inglês, para o gerador de imagem) descrevendo uma imagem visual minimalista e profissional para o fundo ou lateral.`;
            }

            const response = await ai.models.generateContent({
                model: "gemini-2.5-flash",
                contents: prompt,
                config: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: Type.OBJECT,
                        properties: {
                            topic: { type: Type.STRING },
                            slides: {
                                type: Type.ARRAY,
                                items: {
                                    type: Type.OBJECT,
                                    properties: {
                                        title: { type: Type.STRING },
                                        content: { type: Type.ARRAY, items: { type: Type.STRING } },
                                        type: { type: Type.STRING, enum: ["title", "content", "summary"] },
                                        imageDescription: { type: Type.STRING }
                                    },
                                    required: ["title", "content", "type"]
                                }
                            }
                        },
                        required: ["topic", "slides"]
                    }
                }
            });
            return response.text;
        };

        // --- 3. Export Services ---
        window.generatePDFJS = async (filename) => {
            const { jsPDF } = window.jspdf;
            const container = document.getElementById('pdf-hidden-container');
            const slides = container.querySelectorAll('.slide-node');
            if (slides.length === 0) return;
            
            // 4:3 Ratio in Points (approx)
            const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: [800, 600] });

            for (let i = 0; i < slides.length; i++) {
                const slide = slides[i];
                const imgs = slide.querySelectorAll('img');
                await Promise.all(Array.from(imgs).map(img => {
                    if (img.complete) return Promise.resolve();
                    return new Promise(resolve => { img.onload = resolve; img.onerror = resolve; });
                }));
                const canvas = await window.html2canvas(slide, { scale: 2, useCORS: true, logging: false });
                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                if (i > 0) doc.addPage([800, 600], 'landscape');
                doc.addImage(imgData, 'JPEG', 0, 0, 800, 600);
            }
            doc.save(`${filename}.pdf`);
        };

        window.downloadHTMLJS = (filename, content) => {
            const element = document.createElement('a');
            const file = new Blob([content], {type: 'text/html'});
            element.href = URL.createObjectURL(file);
            element.download = filename;
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        };

        window.generatePPTXJS = async (topic, slidesData, themeData, fontName) => {
            const pres = new PptxGenJS();
            pres.layout = 'LAYOUT_4x3';
            pres.title = topic;
            
            const bgHex = themeData.bg.replace('#', '');
            const textHex = themeData.text.replace('#', '');
            const accentHex = themeData.accent.replace('#', '');
            
            const fontMap = { 'Inter': 'Arial', 'Roboto': 'Arial', 'Lora': 'Georgia', 'Montserrat': 'Verdana', 'Open Sans': 'Calibri' };
            const pptFont = fontMap[fontName] || 'Arial';

            for (const slide of slidesData) {
                let pptSlide = pres.addSlide();
                pptSlide.background = { color: bgHex };

                // Handle Image (Base64 or URL)
                if (slide.imageUrl) {
                    // Try to convert to Base64 if it's a URL to ensure it embeds
                    let imgData = slide.imageUrl;
                    if (imgData.startsWith('http')) {
                        const b64 = await window.urlToBase64(imgData);
                        if (b64) imgData = b64;
                    }

                    if (slide.type === 'title' || slide.type === 'summary') {
                         pptSlide.addImage({ data: imgData, x: 0, y: 0, w: '100%', h: '100%', transparency: 85 });
                    } else {
                         pptSlide.addImage({ data: imgData, x: 7, y: 1.5, w: 2.5, h: 2.5 });
                    }
                }

                if (slide.type === 'title' || slide.type === 'summary') {
                    pptSlide.addText(slide.title, { x: 0.5, y: 2.5, w: '90%', h: 1, fontSize: 36, color: accentHex, bold: true, align: 'center', fontFace: pptFont });
                    if (slide.content.length > 0) {
                        pptSlide.addText(slide.content.join('\n'), { x: 1, y: 3.8, w: '80%', h: 2, fontSize: 18, color: textHex, align: 'center', fontFace: pptFont });
                    }
                } else {
                    pptSlide.addText(slide.title, { x: 0.5, y: 0.5, w: '90%', h: 1, fontSize: 32, color: accentHex, bold: true, align: 'left', fontFace: pptFont });
                    let contentW = slide.imageUrl ? 6 : 9;
                    pptSlide.addText(slide.content.map(c => c).join('\n'), { x: 0.5, y: 1.5, w: contentW, h: 4.5, fontSize: 18, color: textHex, bullet: true, align: 'left', fontFace: pptFont, lineSpacing: 24 });
                }
            }
            pres.writeFile({ fileName: `${topic.replace(/\s+/g, '_')}.pptx` });
        }
    </script>

    <!-- App Shell -->
    <div id="app" class="flex w-full h-full">
        
        <!-- Hidden Image Input for Edit/Upload -->
        <input type="file" id="hidden-image-input" class="hidden" accept="image/*" />

        <!-- Minimalist Sidebar -->
        <div class="w-80 bg-white border-r border-gray-100 flex flex-col shadow-sm z-20 flex-shrink-0">
            <!-- Branding -->
            <div class="p-6">
                <h1 class="font-bold text-xl text-black tracking-tight flex items-center gap-2">
                    <span class="w-2 h-6 bg-brand-accent rounded-sm"></span>
                    AutoSlide <span class="text-gray-400 font-normal">AI</span>
                </h1>
            </div>
            
            <div class="flex-1 overflow-y-auto px-6 pb-6 space-y-8">
                
                <!-- Section 1: Content -->
                <div class="space-y-4">
                    <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Conteúdo</label>
                    
                    <div class="relative group">
                         <label for="pdf-upload" class="flex items-center justify-center w-full px-4 py-3 border border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-brand-accent hover:bg-blue-50 transition-all bg-gray-50">
                            <svg class="w-5 h-5 text-gray-400 mr-2 group-hover:text-brand-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            <span class="text-sm font-medium text-gray-600 group-hover:text-brand-accent">Importar PDF</span>
                            <input id="pdf-upload" type="file" class="hidden" accept=".pdf" />
                        </label>
                    </div>

                    <textarea id="topic-input" class="w-full h-28 p-3 rounded-lg border border-gray-200 text-sm focus:ring-2 focus:ring-black focus:border-transparent outline-none resize-none bg-gray-50 placeholder-gray-400 transition-shadow" placeholder="Digite o tema ou cole seu texto aqui..."></textarea>
                    
                    <div class="flex items-center justify-between">
                        <label for="chk-images" class="text-sm font-medium text-gray-600 cursor-pointer select-none">Gerar Imagens (IA)</label>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="chk-images" id="chk-images" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300 checked:right-0 checked:border-brand-accent transition-all"/>
                            <label for="chk-images" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>

                    <button id="generate-btn" py-click="controller.handle_generate" class="w-full py-3 bg-black hover:bg-gray-800 text-white rounded-lg text-sm font-semibold transition-transform active:scale-95 shadow-lg shadow-gray-200">
                        Gerar Slides
                    </button>
                </div>

                <hr class="border-gray-100">

                <!-- Section 2: Design -->
                 <div class="space-y-4">
                    <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Estilo & Cores</label>
                    
                    <div>
                        <span class="text-xs text-gray-500 mb-2 block">Tipografia</span>
                        <select id="font-select" class="w-full p-2.5 text-sm border border-gray-200 rounded-lg bg-white focus:ring-1 focus:ring-black outline-none cursor-pointer">
                            <option value="Inter" selected>Inter (Moderno)</option>
                            <option value="Roboto">Roboto (Neutro)</option>
                            <option value="Lora">Lora (Elegante)</option>
                            <option value="Montserrat">Montserrat (Bold)</option>
                            <option value="Open Sans">Open Sans (Amigável)</option>
                        </select>
                    </div>

                    <!-- Add Background Image Button -->
                    <button id="btn-bg-image" py-click="controller.handle_bg_change_click" class="w-full flex items-center justify-center gap-2 p-2 border border-gray-200 rounded-lg text-sm text-gray-600 hover:bg-gray-50 hover:text-black transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        Imagem de Fundo (Slide Atual)
                    </button>

                    <!-- Custom Color Picker Menu -->
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-100 space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-600">Fundo</span>
                            <div class="flex items-center gap-2">
                                <span id="hex-bg" class="text-xs font-mono text-gray-400">#FFFFFF</span>
                                <input type="color" id="col-bg" value="#ffffff" title="Cor de Fundo">
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-600">Texto</span>
                            <div class="flex items-center gap-2">
                                <span id="hex-text" class="text-xs font-mono text-gray-400">#1A1A1A</span>
                                <input type="color" id="col-text" value="#1a1a1a" title="Cor do Texto">
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-600">Destaque</span>
                            <div class="flex items-center gap-2">
                                <span id="hex-accent" class="text-xs font-mono text-gray-400">#2563EB</span>
                                <input type="color" id="col-accent" value="#2563eb" title="Cor de Destaque">
                            </div>
                        </div>
                    </div>

                    <!-- Quick Presets -->
                    <div class="grid grid-cols-4 gap-2">
                         <button id="preset-light" class="h-8 rounded border bg-white hover:ring-2 ring-black ring-offset-1" title="Claro"></button>
                         <button id="preset-dark" class="h-8 rounded border bg-slate-900 hover:ring-2 ring-black ring-offset-1" title="Escuro"></button>
                         <button id="preset-navy" class="h-8 rounded border bg-blue-900 hover:ring-2 ring-black ring-offset-1" title="Marinho"></button>
                         <button id="preset-forest" class="h-8 rounded border bg-emerald-900 hover:ring-2 ring-black ring-offset-1" title="Floresta"></button>
                    </div>
                </div>

                <hr class="border-gray-100">

                <!-- Section 3: Export -->
                <div class="space-y-4">
                    <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Exportar</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button id="btn-export-pptx" py-click="controller.handle_export_pptx" disabled class="flex flex-col items-center justify-center p-3 border border-gray-200 rounded-lg transition-all text-gray-400 cursor-not-allowed opacity-50">
                            <span class="text-xs font-bold">PPTX</span>
                        </button>
                        <button id="btn-export-pdf" py-click="controller.handle_export_pdf" disabled class="flex flex-col items-center justify-center p-3 border border-gray-200 rounded-lg transition-all text-gray-400 cursor-not-allowed opacity-50">
                            <span class="text-xs font-bold">PDF</span>
                        </button>
                        <button id="btn-export-html" py-click="controller.handle_export_html" disabled class="flex flex-col items-center justify-center p-3 border border-gray-200 rounded-lg transition-all text-gray-400 cursor-not-allowed opacity-50">
                            <span class="text-xs font-bold">HTML</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Preview -->
        <div class="flex-1 bg-gray-100 flex flex-col relative overflow-hidden">
            <!-- Toolbar -->
            <div class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-8 shadow-sm z-10">
                <span id="header-topic" class="font-semibold text-gray-800 truncate text-base max-w-lg">Apresentação Sem Título</span>
                <div class="flex items-center gap-4">
                    <span id="slide-counter" class="text-xs font-mono bg-gray-100 text-gray-600 px-3 py-1.5 rounded-full">1 / 1</span>
                    <div class="flex gap-1 bg-gray-100 p-1 rounded-lg">
                        <button py-click="controller.prev_slide" title="Anterior (PageUp)" class="p-2 hover:bg-white hover:shadow-sm rounded-md text-gray-600 transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <button py-click="controller.next_slide" title="Próximo (PageDown)" class="p-2 hover:bg-white hover:shadow-sm rounded-md text-gray-600 transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Slide Stage -->
            <div class="flex-1 flex items-center justify-center p-10 overflow-hidden bg-gray-50/50">
                <div id="slide-stage" class="w-full max-w-5xl shadow-2xl transition-all duration-300 rounded-xl ring-1 ring-black/5 bg-white">
                    <!-- Rendered Slide -->
                </div>
            </div>
        </div>
    </div>

    <div id="pdf-hidden-container" class="absolute top-0 left-0 pointer-events-none opacity-0 -z-50 w-[800px]"></div>

    <!-- Python Logic -->
    <script type="py">
import json
import asyncio
from js import document, window, console, JSON
from pyodide.ffi import create_proxy

# Initial Portuguese Content
INITIAL_SLIDES = [
    {
        "title": "Bem-vindo ao AutoSlide", 
        "content": ["Importe um PDF ou digite um tópico", "Customize as cores no menu lateral", "Clique em Gerar Slides", "Use PageUp/PageDown para navegar"], 
        "type": "title",
        "imageDescription": "",
        "imageUrl": ""
    }
]

controller = None

class PresentationModel:
    def __init__(self):
        self.topic = "Minha Apresentação"
        self.slides = INITIAL_SLIDES
        self.theme = {
            "bg": "#ffffff",
            "text": "#1a1a1a",
            "accent": "#2563eb"
        }
        self.font = "Inter"
        self.current_index = 0
        self.is_generating = False
        self.observers = []

    def subscribe(self, observer):
        self.observers.append(observer)

    def notify(self):
        for observer in self.observers:
            observer.update(self)

    def set_slides(self, topic, slides):
        self.topic = topic
        # Pre-process slides to generate image URLs from descriptions if not present
        processed_slides = []
        for slide in slides:
            s = slide.copy()
            if "imageDescription" in s and s["imageDescription"] and "imageUrl" not in s:
                encoded = window.encodeURIComponent(s["imageDescription"])
                s["imageUrl"] = f"https://image.pollinations.ai/prompt/{encoded}?width=800&height=600&nologo=true"
            elif "imageUrl" not in s:
                s["imageUrl"] = ""
            processed_slides.append(s)
            
        self.slides = processed_slides
        self.current_index = 0
        self.notify()

    def update_slide_image(self, index, new_url):
        if 0 <= index < len(self.slides):
            self.slides[index]["imageUrl"] = new_url
            self.notify()

    def update_theme_color(self, key, value):
        if key in self.theme:
            self.theme[key] = value
            self.notify()

    def set_font(self, font_name):
        self.font = font_name
        self.notify()

    def next_slide(self):
        if self.current_index < len(self.slides) - 1:
            self.current_index += 1
            self.notify()

    def prev_slide(self):
        if self.current_index > 0:
            self.current_index -= 1
            self.notify()

    def set_generating(self, is_gen):
        self.is_generating = is_gen
        self.notify()

class PresentationView:
    def __init__(self):
        self.slide_stage = document.getElementById("slide-stage")
        self.slide_counter = document.getElementById("slide-counter")
        self.header_topic = document.getElementById("header-topic")
        self.topic_input = document.getElementById("topic-input")
        self.generate_btn = document.getElementById("generate-btn")
        self.pdf_container = document.getElementById("pdf-hidden-container")
        
        # Inputs
        self.font_select = document.getElementById("font-select")
        self.pdf_upload = document.getElementById("pdf-upload")
        
        # Color Inputs
        self.col_bg = document.getElementById("col-bg")
        self.col_text = document.getElementById("col-text")
        self.col_accent = document.getElementById("col-accent")
        
        # Hex Labels
        self.hex_bg = document.getElementById("hex-bg")
        self.hex_text = document.getElementById("hex-text")
        self.hex_accent = document.getElementById("hex-accent")

        # Presets
        self.preset_light = document.getElementById("preset-light")
        self.preset_dark = document.getElementById("preset-dark")
        self.preset_navy = document.getElementById("preset-navy")
        self.preset_forest = document.getElementById("preset-forest")

        # Export Buttons
        self.btn_export_pptx = document.getElementById("btn-export-pptx")
        self.btn_export_pdf = document.getElementById("btn-export-pdf")
        self.btn_export_html = document.getElementById("btn-export-html")

        # Hidden Image Input
        self.hidden_image_input = document.getElementById("hidden-image-input")

        self.controller_proxy = None

    def init_ui(self, model, controller_proxy):
        self.controller_proxy = controller_proxy
        # Bind Main Inputs
        self.pdf_upload.addEventListener("change", create_proxy(controller_proxy.handle_pdf_upload))
        self.font_select.addEventListener("change", create_proxy(controller_proxy.handle_font_change))
        
        # Bind Hidden Image Input
        self.hidden_image_input.addEventListener("change", create_proxy(controller_proxy.handle_file_input_change))

        # Bind Colors
        self.col_bg.addEventListener("input", create_proxy(lambda e: controller_proxy.handle_color_change("bg", e.target.value)))
        self.col_text.addEventListener("input", create_proxy(lambda e: controller_proxy.handle_color_change("text", e.target.value)))
        self.col_accent.addEventListener("input", create_proxy(lambda e: controller_proxy.handle_color_change("accent", e.target.value)))

        # Bind Presets
        self.preset_light.addEventListener("click", create_proxy(lambda e: controller_proxy.apply_preset("#ffffff", "#1a1a1a", "#2563eb")))
        self.preset_dark.addEventListener("click", create_proxy(lambda e: controller_proxy.apply_preset("#0f172a", "#f8fafc", "#38bdf8")))
        self.preset_navy.addEventListener("click", create_proxy(lambda e: controller_proxy.apply_preset("#1e1b4b", "#e0e7ff", "#818cf8")))
        self.preset_forest.addEventListener("click", create_proxy(lambda e: controller_proxy.apply_preset("#022c22", "#ecfdf5", "#34d399")))

        # Bind Keyboard Navigation (Global)
        document.addEventListener("keydown", create_proxy(controller_proxy.handle_keydown))

        self.update(model)

    def generate_html_string(self, slide, theme, index, total, font, is_preview=True):
        bg = theme["bg"]
        text = theme["text"]
        accent = theme["accent"]
        
        base_style = f"background-color: {bg}; color: {text}; font-family: '{font}', sans-serif;"
        
        img_html = ""
        edit_btn_html = ""

        if "imageUrl" in slide and slide["imageUrl"]:
             url = slide["imageUrl"]
             if slide["type"] in ["title", "summary"]:
                 img_html = f'<div class="absolute inset-0 z-0 opacity-20 pointer-events-none"><img src="{url}" class="w-full h-full object-cover filter grayscale-[20%]" /></div>'
             else:
                 img_html = f'''
                 <div class="flex justify-end items-center my-4 h-full absolute right-12 top-0 w-1/3 slide-image-container group z-10">
                    <img src="{url}" class="w-full h-auto rounded-lg shadow-xl object-cover aspect-square" />
                    {'<button class="edit-image-btn absolute top-2 right-2 bg-black/70 text-white p-2 rounded-full opacity-0 transition-opacity hover:bg-black" onclick="controller.handle_image_upload_trigger(' + str(index) + ')"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>' if is_preview else ''}
                 </div>'''
                 
             # Edit button for full background images (Title/Summary)
             if is_preview and slide["type"] in ["title", "summary"]:
                 edit_btn_html = f'<button class="absolute top-4 right-4 z-50 bg-white/20 hover:bg-white/40 backdrop-blur text-{text} p-2 rounded-lg border border-{text}/20" onclick="controller.handle_image_upload_trigger({index})">Trocar Imagem</button>'

        content_html = ""
        
        # CSS Overflow / Height safety classes are added here
        
        if slide["type"] == "title":
            items = "".join([f'<p class="text-xl opacity-80 mt-6 font-light">{item}</p>' for item in slide["content"]])
            content_html = f'''
                {img_html}
                {edit_btn_html}
                <div class="relative z-10 flex flex-col items-center justify-center h-full p-16 text-center max-h-full overflow-hidden">
                    <div class="w-16 h-2 mb-8 rounded-full flex-shrink-0" style="background-color: {accent}"></div>
                    <h1 class="text-6xl font-bold mb-4 leading-tight tracking-tight max-h-[40%] overflow-hidden">{slide["title"]}</h1>
                    <div class="max-w-2xl overflow-hidden">{items}</div>
                </div>
            '''
        elif slide["type"] == "summary":
            items = "".join([f'<p class="text-2xl mb-4 leading-relaxed font-light">{item}</p>' for item in slide["content"]])
            content_html = f'''
                {img_html}
                {edit_btn_html}
                <div class="relative z-10 flex flex-col items-center justify-center h-full p-16 text-center max-h-full overflow-hidden">
                    <h2 class="text-4xl font-bold mb-8 flex-shrink-0" style="color: {accent}">{slide["title"]}</h2>
                    <div class="max-w-3xl border-t border-b py-8 overflow-hidden" style="border-color: {text}30">
                        {items}
                    </div>
                </div>
            '''
        else:
            items = "".join([f'<li class="mb-4 text-2xl leading-relaxed pl-2">{item}</li>' for item in slide["content"]])
            width_class = "w-3/5" if img_html else "w-full max-w-4xl"
            
            content_html = f'''
                <div class="relative z-10 flex flex-col h-full p-12 px-16 max-h-full overflow-hidden">
                    <div class="flex items-center mb-10 pb-4 border-b-2 flex-shrink-0" style="border-color: {accent}">
                        <h2 class="text-4xl font-bold tracking-tight truncate">{slide["title"]}</h2>
                    </div>
                    {img_html}
                    <div class="{width_class} pr-8 flex-1 overflow-hidden">
                        <ul class="list-disc pl-8 marker:text-[{accent}] max-h-full overflow-hidden" style="marker-color: {accent}">{items}</ul>
                    </div>
                </div>
            '''

        container_class = "w-full aspect-[4/3] relative overflow-hidden select-none" if is_preview else "w-[800px] h-[600px] relative overflow-hidden slide-node mb-10"
        
        return f'''
            <div class="{container_class}" style="{base_style}">
                {content_html}
                <div class="absolute bottom-6 right-8 text-xs font-bold opacity-40 uppercase tracking-widest">{index + 1} / {total}</div>
            </div>
        '''

    def update(self, model):
        self.col_bg.value = model.theme["bg"]
        self.hex_bg.innerText = model.theme["bg"].upper()
        
        self.col_text.value = model.theme["text"]
        self.hex_text.innerText = model.theme["text"].upper()
        
        self.col_accent.value = model.theme["accent"]
        self.hex_accent.innerText = model.theme["accent"].upper()

        current_slide = model.slides[model.current_index]
        html = self.generate_html_string(
            current_slide, 
            model.theme, 
            model.current_index, 
            len(model.slides),
            model.font
        )
        self.slide_stage.innerHTML = html
        self.header_topic.innerText = model.topic
        self.slide_counter.innerText = f"{model.current_index + 1} / {len(model.slides)}"

        # Handle Generation State & Export Buttons
        if model.is_generating:
            self.generate_btn.disabled = True
            self.generate_btn.innerHTML = '<div class="loading-spinner inline-block mr-2"></div> Processando...'
            self.generate_btn.classList.add("opacity-75", "cursor-not-allowed")
            
            # Disable Exports
            for btn in [self.btn_export_pptx, self.btn_export_pdf, self.btn_export_html]:
                btn.disabled = True
                btn.classList.add("opacity-50", "cursor-not-allowed")
                btn.classList.remove("hover:bg-orange-50", "hover:text-orange-600", "hover:bg-red-50", "hover:text-red-600", "hover:bg-blue-50", "hover:text-blue-600")

        else:
            self.generate_btn.disabled = False
            self.generate_btn.innerHTML = 'Gerar Slides'
            self.generate_btn.classList.remove("opacity-75", "cursor-not-allowed")
            
            # Enable Exports
            for btn in [self.btn_export_pptx, self.btn_export_pdf, self.btn_export_html]:
                btn.disabled = False
                btn.classList.remove("opacity-50", "cursor-not-allowed")
                
            # Re-add hover classes (simplified)
            self.btn_export_pptx.classList.add("hover:bg-orange-50", "hover:text-orange-600")
            self.btn_export_pdf.classList.add("hover:bg-red-50", "hover:text-red-600")
            self.btn_export_html.classList.add("hover:bg-blue-50", "hover:text-blue-600")

    def prepare_pdf_dom(self, model):
        html_all = ""
        for i, slide in enumerate(model.slides):
            html_all += self.generate_html_string(slide, model.theme, i, len(model.slides), model.font, is_preview=False)
        self.pdf_container.innerHTML = html_all

class PresentationController:
    def __init__(self, model, view):
        self.model = model
        self.view = view
        self.pending_image_slide_index = -1
        self.view.init_ui(model, self)

    def handle_keydown(self, event):
        if event.key == "PageUp":
            self.prev_slide()
            event.preventDefault()
        elif event.key == "PageDown":
            self.next_slide()
            event.preventDefault()

    def handle_color_change(self, key, value):
        self.model.update_theme_color(key, value)

    def apply_preset(self, bg, text, accent):
        self.model.update_theme_color("bg", bg)
        self.model.update_theme_color("text", text)
        self.model.update_theme_color("accent", accent)

    def handle_font_change(self, event):
        self.model.set_font(event.target.value)

    def next_slide(self, event=None):
        self.model.next_slide()

    def prev_slide(self, event=None):
        self.model.prev_slide()

    # Triggered by Edit Icon inside slide OR Sidebar button
    def handle_image_upload_trigger(self, index):
        self.pending_image_slide_index = index
        # Trigger the hidden file input
        self.view.hidden_image_input.click()

    # Triggered by "Imagem de Fundo" button in sidebar for CURRENT slide
    def handle_bg_change_click(self, event=None):
        self.handle_image_upload_trigger(self.model.current_index)

    async def handle_file_input_change(self, event):
        if self.pending_image_slide_index == -1:
            return
            
        try:
            # Read file via JS helper
            base64_img = await window.readLocalFileToBase64("hidden-image-input")
            if base64_img:
                self.model.update_slide_image(self.pending_image_slide_index, base64_img)
        except Exception as e:
            console.error(f"Error reading file: {str(e)}")
            window.alert("Erro ao ler imagem.")
        finally:
            # Reset input value so same file can be selected again if needed
            self.view.hidden_image_input.value = ""
            self.pending_image_slide_index = -1

    # Keep old method for backward compat if needed, but updated logic relies on file upload now
    def handle_image_edit(self, index):
        self.handle_image_upload_trigger(index)

    async def handle_pdf_upload(self, event):
        self.model.set_generating(True)
        try:
            text = await window.extractPdfTextJS("pdf-upload")
            if text:
                self.view.topic_input.value = text.strip()[:30000]
            else:
                window.alert("Não foi possível extrair o texto.")
        except Exception as e:
            console.error(str(e))
        finally:
            self.model.set_generating(False)

    async def handle_generate(self, event=None):
        topic_text = self.view.topic_input.value
        if not topic_text.strip():
            window.alert("Por favor, digite um tópico ou conteúdo.")
            return

        include_images = document.getElementById("chk-images").checked
        self.model.set_generating(True)
        
        try:
            api_key = window.API_KEY
            if not api_key:
                window.alert("API Key não encontrada.")
                self.model.set_generating(False)
                return

            json_response = await window.generateSlidesJS(api_key, topic_text, include_images)
            data = json.loads(json_response)
            self.model.set_slides(data["topic"], data["slides"])
            
        except Exception as e:
            console.error(f"Error: {str(e)}")
            window.alert("Falha ao gerar slides. Verifique o console.")
        finally:
            self.model.set_generating(False)

    async def handle_export_pdf(self, event=None):
        if self.model.is_generating: return
        self.model.set_generating(True)
        try:
            self.view.prepare_pdf_dom(self.model)
            await asyncio.sleep(0.5) 
            await window.generatePDFJS(self.model.topic.replace(" ", "_"))
        finally:
            self.model.set_generating(False)
            self.view.pdf_container.innerHTML = ""

    async def handle_export_pptx(self, event=None):
        if self.model.is_generating: return
        self.model.set_generating(True)
        try:
            slides_copy = json.loads(json.dumps(self.model.slides))
            # Convert images to Base64 for PPTX embedding
            for slide in slides_copy:
                if "imageUrl" in slide and slide["imageUrl"]:
                     b64 = await window.urlToBase64(slide["imageUrl"])
                     if b64:
                         slide["imageUrl"] = b64

            slides_json = json.dumps(slides_copy)
            theme_json = json.dumps(self.model.theme)
            js_slides = JSON.parse(slides_json)
            js_theme = JSON.parse(theme_json)
            await window.generatePPTXJS(self.model.topic, js_slides, js_theme, self.model.font)
        except Exception as e:
            console.error(str(e))
            window.alert("Erro ao exportar PPTX")
        finally:
             self.model.set_generating(False)

    async def handle_export_html(self, event=None):
        if self.model.is_generating: return
        self.model.set_generating(True)
        try:
            theme = self.model.theme
            font = self.model.font
            slides_content = ""
            
            for i, slide in enumerate(self.model.slides):
                active_class = "active" if i == 0 else ""
                
                img_html = ""
                if "imageUrl" in slide and slide["imageUrl"]:
                    # Convert to Base64 for standalone HTML
                    b64 = await window.urlToBase64(slide["imageUrl"])
                    url = b64 if b64 else slide["imageUrl"]
                    img_html = f'<div class="img-box"><img src="{url}" alt="Slide"></div>'

                if slide["type"] == "title":
                    content = "".join([f'<p class="sub">{item}</p>' for item in slide["content"]])
                    slides_content += f'''
                    <div class="slide {active_class} title-slide">
                        <h1>{slide['title']}</h1>
                        <div class="divider"></div>
                        {content}
                        {img_html}
                    </div>'''
                else:
                    content = "".join([f'<li>{item}</li>' for item in slide["content"]])
                    slides_content += f'''
                    <div class="slide {active_class}">
                        <h2>{slide['title']}</h2>
                        {img_html}
                        <ul>{content}</ul>
                    </div>'''

            script_open = "<script>"
            script_close = "<" + "/script>"
            
            full_html = f"""
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"><title>{self.model.topic}</title>
<link href="https://fonts.googleapis.com/css2?family={font}:wght@300;600;800&display=swap" rel="stylesheet">
<style>
:root {{ --bg: {theme['bg']}; --text: {theme['text']}; --accent: {theme['accent']}; --font: '{font}', sans-serif; }}
body {{ margin:0; font-family: var(--font); background: #eee; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; }}
.deck {{ width: 90vw; height: 90vh; background: var(--bg); color: var(--text); border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); position: relative; overflow: hidden; }}
.slide {{ width: 100%; height: 100%; position: absolute; top: 0; left: 0; opacity: 0; transition: opacity 0.5s; padding: 60px 80px; box-sizing: border-box; display: flex; flex-direction: column; }}
.slide.active {{ opacity: 1; z-index: 1; }}
h1 {{ font-size: 4em; font-weight: 800; color: var(--accent); margin: 0 0 20px 0; }}
h2 {{ font-size: 3em; font-weight: 700; border-bottom: 3px solid var(--accent); padding-bottom: 10px; margin-bottom: 40px; }}
ul {{ font-size: 1.8em; line-height: 1.6; }}
li {{ margin-bottom: 15px; }}
.title-slide {{ justify-content: center; text-align: center; align-items: center; }}
.divider {{ width: 100px; height: 6px; background: var(--accent); margin: 0 auto 30px auto; border-radius: 3px; }}
.sub {{ font-size: 1.5em; opacity: 0.8; }}
.controls {{ position: fixed; bottom: 30px; right: 40px; z-index: 10; font-family: monospace; background: rgba(255,255,255,0.8); padding: 10px 20px; border-radius: 30px; color: #000; }}
.img-box img {{ max-height: 300px; max-width: 40%; position: absolute; right: 50px; bottom: 50px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }}
.title-slide .img-box img {{ display: none; }}
</style>
</head>
<body>
<div class="deck">{slides_content}</div>
<div class="controls">Use PageUp/PageDown ou Setas</div>
{script_open}
let idx = 0; const slides = document.querySelectorAll('.slide');
document.addEventListener('keydown', e => {{
    if(e.key === 'ArrowRight' || e.key === ' ' || e.key === 'PageDown') {{ slides[idx].classList.remove('active'); idx = (idx+1)%slides.length; slides[idx].classList.add('active'); }}
    if(e.key === 'ArrowLeft' || e.key === 'PageUp') {{ slides[idx].classList.remove('active'); idx = (idx-1+slides.length)%slides.length; slides[idx].classList.add('active'); }}
}});
{script_close}
</body></html>"""
            window.downloadHTMLJS(f"{self.model.topic.replace(' ', '_')}.html", full_html)
        finally:
            self.model.set_generating(False)

async def main():
    model = PresentationModel()
    view = PresentationView()
    model.subscribe(view)
    
    global controller
    inst_controller = PresentationController(model, view)
    
    # Assign to Python global scope for py-click
    controller = inst_controller
    
    # Assign to Window for JS onclick (used by generated edit buttons)
    window.controller = create_proxy(inst_controller)

asyncio.ensure_future(main())
    </script>
</body>
</html>